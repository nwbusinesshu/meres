name: üöÄ Deploy to Production (app.quarma360.com)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy Laravel App to Production Server
    runs-on: ubuntu-latest

    steps:
      - name: üß© Checkout code
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: mbstring, intl, mysql, bcmath, gd, curl, xml, zip
          tools: composer

      - name: üß± Install dependencies
        run: |
          composer install --no-dev --optimize-autoloader
          php artisan config:clear || true

      - name: üì¶ Create deployment package
        run: |
          echo "Current directory:"
          pwd
          ls -la
          tar -czf release.tgz \
            --exclude=.git \
            --exclude=node_modules \
            --exclude=./vendor \
            --exclude=storage/logs \
            --exclude=.github \
            . || true

      - name: üì§ Upload to production server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.PROD_HOST }}
          username: deployer
          key: ${{ secrets.PROD_SSH_KEY }}
          source: "release.tgz"
          target: "/var/www/quarma360-production/"

      - name: üöÄ Run deploy commands on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PROD_HOST }}
          username: deployer
          key: ${{ secrets.PROD_SSH_KEY }}
          script: |
            set -e
            cd /var/www/quarma360-production
            REL=$(date +%Y%m%d%H%M%S)
            mkdir -p releases/$REL
            tar -xzf release.tgz -C releases/$REL
            rm release.tgz

            # ‚úÖ SET CORRECT PERMISSIONS (with setgid for permanent fix)
            echo "Setting correct permissions..."
            sudo chown -R deployer:www-data releases/$REL
            sudo find releases/$REL -type d -exec chmod 775 {} \;
            sudo find releases/$REL -type f -exec chmod 664 {} \;
            
            # ‚úÖ SET SETGID BIT on storage/cache directories (permanent fix)
            sudo find releases/$REL/storage -type d -exec chmod g+s {} \;
            sudo find releases/$REL/bootstrap/cache -type d -exec chmod g+s {} \;

            # Link .env
            ln -sfn /var/www/quarma360-production/shared/.env releases/$REL/.env

            cd releases/$REL

            # Make executables
            chmod +x artisan
            chmod +x composer
            find . -type f -name "*.sh" -exec chmod +x {} \;

            # Install dependencies
            composer install --no-dev --optimize-autoloader

            # Create symlinks FIRST before caching
            rm -rf storage
            ln -sfn /var/www/quarma360-production/shared/storage storage
            rm -rf public/uploads
            ln -sfn /var/www/quarma360-production/shared/uploads public/uploads
            php artisan storage:link || true
            
            # ‚úÖ FIX PERMISSIONS on shared storage too
            sudo find /var/www/quarma360-production/shared/storage -type d -exec chmod g+s {} \;
            sudo chmod -R 775 /var/www/quarma360-production/shared/storage

            # ‚úÖ CLEAR CACHES before caching (important!)
            php artisan view:clear
            php artisan cache:clear
            php artisan config:clear

            # NOW cache config (with correct symlinked paths)
            php artisan config:cache
            php artisan route:cache

            # Switch to new release
            cd /var/www/quarma360-production
            ln -sfn /var/www/quarma360-production/releases/$REL current

            cd /var/www/quarma360-production/current
            echo "Running database migrations..."
            php artisan migrate --force
            
            # Restart queue workers if you use them
            php artisan queue:restart || true

            # Reload PHP-FPM
            sudo systemctl reload php8.3-fpm

            # Clean old releases (keep last 5)
            ls -t releases/ | tail -n +6 | xargs -I {} rm -rf releases/{}

            echo "‚úÖ Hurray! Deployment completed successfully!"