name: üöÄ Deploy to Production (app.quarma360.com)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy Laravel App to Production Server
    runs-on: ubuntu-latest

    steps:
      - name: üß© Checkout code
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: mbstring, intl, mysql, bcmath, gd, curl, xml, zip
          tools: composer

      - name: üß± Install dependencies
        run: |
          composer install --no-dev --optimize-autoloader
          php artisan config:clear || true

      - name: üì¶ Create deployment package
        run: |
          echo "Current directory:"
          pwd
          ls -la
          tar -czf release.tgz \
            --exclude=.git \
            --exclude=node_modules \
            --exclude=vendor \
            --exclude=storage/logs \
            --exclude=.github \
            . || true

      - name: üì§ Upload to production server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.PROD_HOST }}
          username: deployer
          key: ${{ secrets.PROD_SSH_KEY }}
          source: "release.tgz"
          target: "/var/www/quarma360-production/"

      - name: üöÄ Run deploy commands on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PROD_HOST }}
          username: deployer
          key: ${{ secrets.PROD_SSH_KEY }}
          script: |
            set -e
            cd /var/www/quarma360-production
            REL=$(date +%Y%m%d%H%M%S)
            mkdir -p releases/$REL
            tar -xzf release.tgz -C releases/$REL
            rm release.tgz
            ln -sfn /var/www/quarma360-production/shared/.env releases/$REL/.env
            cd releases/$REL
            composer install --no-dev --optimize-autoloader
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache || true
            php artisan storage:link || true
            rm -rf storage
            ln -sfn /var/www/quarma360-production/shared/storage storage
            rm -rf public/uploads
            ln -sfn /var/www/quarma360-production/shared/uploads public/uploads
            cd /var/www/quarma360-production
            ln -sfn /var/www/quarma360-production/releases/$REL current
            sudo chown -R quarmaapp:www-data releases/$REL
            sudo systemctl reload php8.3-fpm
            ls -t releases/ | tail -n +6 | xargs -I {} rm -rf releases/{}
